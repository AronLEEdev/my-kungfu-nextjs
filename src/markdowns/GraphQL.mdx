---
title: GraphQL åŸºç¡€å®è·µ nodejs & Java
description: GraphQL æ˜¯ç”±facebookæå‡ºçš„ï¼Œä¸€ç§ååŠ©å‰åå°ä¹‹é—´äº¤æµçš„è¯­è¨€ã€‚æ¯”èµ·ä¼ ç»Ÿçš„REST apiï¼Œä»–ä¸»è¦è§£å†³ overfetching å’Œ underfetching ä¸¤ç§é—®é¢˜ã€‚
---
GraphQL æ˜¯ç”± facebook æå‡ºçš„ï¼Œä¸€ç§ååŠ©å‰åå°ä¹‹é—´äº¤æµçš„è¯­è¨€ã€‚æ¯”èµ·ä¼ ç»Ÿçš„ REST apiï¼Œä»–ä¸»è¦è§£å†³ overfetching å’Œ underfetching ä¸¤ç§é—®é¢˜ã€‚

overfetching ç®€å•æ¥è¯´æŒ‡çš„æ˜¯æˆ‘è°ƒç”¨ä¸€æ¬¡æ¥å£ï¼Œè¿”å›äº† 10 ä¸ªå­—æ®µç»™æˆ‘ï¼Œè€Œæˆ‘å¯èƒ½åªéœ€è¦å…¶ä¸­ 5 ä¸ªå­—æ®µã€‚

è¿™ç§æƒ…å†µæ˜¯æˆ‘ä¸ªäººæœ€å¸¸ç»å†çš„ï¼Œå½“ä½ çš„åº”ç”¨å¯¹æ¥çš„åå°æ˜¯ä¸ªå¾ˆå…¬å…±çš„æœåŠ¡ï¼Œä»–åˆå¯¹æ¥å¤ªå¤šç§Ÿæˆ·æ—¶ï¼Œä»–å¯èƒ½åœ¨ä¸€ä¸ªæ¥å£ä¸ŠæŠŠæ‰€æœ‰å­—æ®µéƒ½åç»™ä½ ï¼Œè€Œå…¶ä¸­ 3 ä¸ªå­—æ®µæ˜¯ç§Ÿæˆ· A æ‰è¦çš„ï¼Œ3 ä¸ªå­—æ®µæ˜¯ç§Ÿæˆ· B è¦çš„ï¼Œæœ€åæ‰æ˜¯ä½ è¦çš„ã€‚å¯¼è‡´æŠ¥æ–‡åˆé•¿åˆæµªè´¹ï¼Œå°¤å…¶æ˜¯åœ¨åšå°ç¨‹åºæ—¶ï¼Œä¸€åˆ‡éƒ½è¦ç²¾ç®€è½»é‡æœ€å¥½ã€‚

underfetching åˆ™æ˜¯æŒ‡çš„æˆ‘éœ€è¦çš„ä¿¡æ¯ï¼Œå¯èƒ½éœ€è¦è°ƒç”¨æ¥å£ Aï¼Œæ‹¿åˆ°æŸä¸ª IDï¼Œå†è°ƒç”¨æ¥å£ Bï¼Œæœ€åæ‰èƒ½æ•´åˆæˆæˆ‘éœ€è¦çš„ä¿¡æ¯ã€‚è¯´ç™½äº†å°±æ˜¯éœ€è¦å¤šæ¬¡è¯·æ±‚è°ƒç”¨ã€‚

æƒ³è¦æ¨åŠ¨è¿™äº›åå°å»ä¼˜åŒ–ä»–ä»¬çš„ API éš¾æ¯”ç™»å¤©ï¼Œé‚£ä¹ˆå‡å¦‚æˆ‘èƒ½åœ¨ä¸­é—´æ­å»ºä¸€ä¸ªæœåŠ¡ï¼Œè¯·æ±‚æ¥å£ååŒ…è£…æˆ GraphQL apiï¼Œå‰ç«¯ç»Ÿä¸€éƒ½ç”¨ graphql è¯·æ±‚çš„è¯ï¼Œæ˜¯å¦ä¼šè®©ä¸€åˆ‡æ–¹ä¾¿è®¸å¤šï¼Ÿ

ä¸‹é¢å°†ä¼šå±•ç¤ºå¦‚ä½•åœ¨ nodeJs ä¸‹æ­å»ºä¸€ä¸ª GraphQL Serverï¼š

é¦–å…ˆæ˜¯æˆ‘çš„ç›®å½•ç»“æ„ï¼š

![](/images/graphql/graphql1.png)

1\. [Apollo Server](https://www.apollographql.com/docs/apollo-server/) :

æˆ‘é€‰æ‹©çš„æœåŠ¡ç«¯æ¡†æ¶æ˜¯ ApolloGraphQLï¼Œä»–æä¾›å®Œæ•´çš„ Server å’Œ Client ä¸¤ä¸ªç«¯çš„æ¡†æ¶ï¼Œç”¨èµ·æ¥ä½“éªŒè¿˜æ˜¯å¾ˆä¸é”™çš„ã€‚

2\. å…³äºç›®å½•ç»“æ„ï¼Œæˆ‘æ˜¯å‚è€ƒé“¾æ¥ï¼š[https://github.com/betaflag/graphql-server-scaffolding](https://github.com/betaflag/graphql-server-scaffolding)

é‡Œé¢æœ‰ä¸‰ç§å…³äºä¸åŒç›®å½•ç»“æ„çš„åˆ†æï¼Œæˆ‘ä¸ªäººè®¤ä¸ºè¿™ç§ç›®å½•ç»“æ„å·²ç»æŠŠ GraphQL çš„æ¦‚å¿µåˆ†çš„å¾ˆæ¸…æ¥šäº†

3\. Data, resolver, typeDefs:

ä»¥ä¸ŠåŸºæœ¬æ¦‚å¿µå¯ä»¥çœ‹å®˜ç½‘ï¼Œæˆ–è€…çœ‹è¿™ä¸ªè§†é¢‘ä¹Ÿè®²çš„å¾ˆæ¸…æ¥š =ã€‹[https://www.youtube.com/watch?v=lKlXdmG0aKQ](https://www.youtube.com/watch?v=lKlXdmG0aKQ)

åé¢å±•å¼€è®²å®é™…å¼€å‘ï¼š

1\. ç±»å‹çš„å®šä¹‰ï¼šä¾‹å¦‚è¿™æ˜¯ä¸€ä¸ªå®é™…çš„ REST API æ¥å£æŠ¥æ–‡ï¼š

æˆ‘ä»¬é¦–å…ˆéœ€è¦åœ¨ typeDefs ä¸‹å†™ä»¥ä¸Šæ¥å£æŠ¥æ–‡é‡Œçš„é‚£äº›ç±»å‹å®šä¹‰ï¼š

\*typeDefs/types/agreement.js

```js
const { gql } = require("apollo-server");

const agreement = gql`
  type AgreementResult {
    scenarioType: String

    versionType: String

    tenantId: String

    tenantName: String

    versionDescription: String

    lastVersion: String

    agreementBody: String

    personalizedSigning: String

    displayStatus: String

    status: String

    agreementName: String
  }

  type Agreement {
    status: String

    code: String

    message: String

    result: [AgreementResult]
  }
`;

module.exports = {
  agreement
};
```

è¿™é‡Œç”¨åˆ°çš„å®šä¹‰è¯­æ³•å«[SDL(schema definition language)](https://www.apollographql.com/docs/apollo-server/schema/schema/)

2\. dataSource

å†æ¥å°±æ˜¯æ•°æ®çš„æ¥æºäº†ï¼›ç½‘ä¸Šçš„è§†é¢‘ï¼ŒåŒ…æ‹¬æˆ‘åœ¨ä¸Šé¢é™„çš„é‚£ä¸ªé“¾æ¥ï¼Œå¤§éƒ¨åˆ†éƒ½æ˜¯é™æ€èµ„æºçš„ datasourceã€‚è€Œåœ¨å®é™…åº”ç”¨ä¸­ï¼Œä¾‹å¦‚æˆ‘è‡ªå·±çš„åœºæ™¯ï¼Œæˆ‘éœ€è¦çš„æ•°æ®æ˜¯ä» rest api è·å–çš„ï¼Œè€Œ apollo ä¹Ÿæœ‰æä¾›å¯¹åº”çš„åº“ - 'apollo-datasource-rest'ï¼›

ï¼ˆå®é™…ä¸Šï¼Œapollo è¿˜æä¾›å¾ˆå¤šç§æ•°æ®æºä¾èµ–åº“ï¼Œå¯ä»¥çœ‹è¿™ä¸ªé“¾æ¥ï¼š[https://www.apollographql.com/docs/apollo-server/data/data-sources/](https://www.apollographql.com/docs/apollo-server/data/data-sources/)ï¼‰

\*data/agreement.js

```js
const { RESTDataSource } = require("apollo-datasource-rest");

class ScrmApi extends RESTDataSource {
  constructor() {
    super();

    this.baseURL = "https://weblink01-ts.huawei.com/";
  }

  async getAgreement() {
    return this.get(
      "/uat/scrm_customer/cui/agreement/newest/v2?appSource=HLife"
    );
  }
}

module.exports = { ScrmApi };
```

ä¸€ä¸ªç®€å•çš„ GET è¯·æ±‚ã€‚

ä½¿ç”¨è¿™ä¸ª dataSourceï¼Œéœ€è¦å»å…¥å£æ–‡ä»¶çš„ ApolloServer ä¸­æ³¨å†Œï¼š

```js
const { ApolloServer } = require("apollo-server");

const { RandomUser, ScrmApi } = require("./data");

const { typeDefs } = require("./typeDefs");

const { resolvers } = require("./resolvers");

//nodejs version under 11 might need this import

require("core-js/stable");

const server = new ApolloServer({
  typeDefs,

  resolvers,

  dataSources: () => ({
    RandomUser: new RandomUser(),

    scrmApi: new ScrmApi()
  })
});

server.listen().then(({ url }) => {
  console.log(`ğŸš€ Server ready at ${url}`);
});
```

3\. resolverï¼šæœ€ååªéœ€è¦åœ¨ resolver ä¸­æ·»åŠ å°±è¡Œäº†

\*resolvers/index.js

```js
const resolvers = {
  Query: {
    getUser: async (_, { gender }, { dataSources }) =>
      dataSources.RandomUser.getUser(gender),

    getUsers: async (_, { people, gender }, { dataSources }) =>
      dataSources.RandomUser.getUsers(people, gender),

    agreements: async (_, __, { dataSources }) => {
      return dataSources.scrmApi.getAgreement();
    }
  }
};

module.exports = {
  resolvers
};
```

æ€»æ–°å¢ä¸€ä¸ª graphQL æŸ¥è¯¢å°±å®Œæˆäº†ï¼Œå¯ä»¥ç”¨ npm run start ç›´æ¥è¿è¡Œï¼Œä¼šå‡ºç°ä¸€ä¸ª graphql-playground çš„é¡µé¢ä¾›ä½ æµ‹è¯•ä½ çš„ APIï¼š

ï¼ˆæ­¤é¡µé¢æ˜¯åŸºäº apollo-server è‡ªå¸¦çš„ä¸€ä¸ª sandbox é¡¹ç›®è¿è¡Œçš„ï¼Œå¯èƒ½ä¼šè¢«å…¬å¸ç½‘å±è”½å¯¼è‡´é¡µé¢åŠ è½½ä¸å‡ºæ¥ï¼Œå¯ä»¥ç”¨ cntlm è½¬å‘æˆ–è€…å¼€é€æ˜ä»£ç†ï¼‰

æœ€ç»ˆé¡µé¢ï¼š

![](/images/graphql/graphql2.png)

å¯ä»¥çœ‹åˆ°ç°åœ¨æˆ‘ä»¬å¯ä»¥æ ¹æ®è‡ªå·±éœ€è¦ï¼Œè·Ÿåå°è·å–è‡ªå·±è¦çš„å­—æ®µï¼Œè¿‡æ»¤æ‰ä¸éœ€è¦çš„å­—æ®µäº†ã€‚è€Œä¸”åœ¨å†™ query æ—¶è¿˜ä¼šè‡ªåŠ¨æç¤ºä½ çš„æ¥å£å­—æ®µã€‚

åˆ°æ­¤ï¼Œä¸€ä¸ªåŸºäº nodeJs çš„åŸºæœ¬ GraphQL server å°±æ­å»ºèµ·æ¥äº†ã€‚éƒ¨ç½²çš„è¯ï¼Œå®˜æ–¹æœ‰æä¾›å¾ˆå¤šè§£å†³æ–¹æ¡ˆï¼Œä¾‹å¦‚ expressï¼Œä¸è¿‡ç”³è¯·èµ„æºå¤ªéº»çƒ¦äº†ï¼Œæˆ‘ä¸ªäººæ²¡æœ‰è¯•è¿‡ã€‚æ„Ÿå…´è¶£çš„å¯ä»¥è¯•ä¸€ä¸‹ã€‚

è€ƒè™‘åˆ°éƒ¨ç½²ï¼Œæˆ‘ä¸ªäººè¿˜æ˜¯è§‰å¾— java ä¼šæ›´æˆç†Ÿä¸€ç‚¹ï¼Œå› æ­¤ä¹ŸåŸºäº java çš„æ­å»ºäº†ä¸€ç‰ˆï¼š

GraphQL æ”¯æŒå¾ˆå¤šè¯­è¨€ä¹Ÿæ˜¯ä»–å¾ˆå¥½çš„ä¸€ä¸ªä¼˜ç‚¹ã€‚

Java ç‰ˆï¼š[https://www.graphql-java.com/tutorials/getting-started-with-spring-boot/](https://www.graphql-java.com/tutorials/getting-started-with-spring-boot/)

æˆ‘åŸºæœ¬ä¸Šæ˜¯ç…§ç€åŸæŒ‡å¯¼æ“ä½œçš„ï¼Œå› æ­¤è¿™é‡Œå°±ä¸å†èµ˜è¿°äº†ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥è‡ªå·±è¯•ä¸€ä¸‹ã€‚

ä¸è¿‡åŸºäºè¿™ç§æ–¹å¼æ­å»ºçš„æœåŠ¡ï¼Œéœ€è¦å¦å¤–æœ‰ä¸ªæµ‹è¯• API çš„é¡µé¢ï¼Œä¹Ÿå°±æ˜¯æ–‡æ¡£é‡Œæœ€åè¯´çš„ [GraphQL Playground](http://https://github.com/graphql/graphql-playground)ã€‚github é“¾æ¥é‡Œæœ‰å¾ˆå¤šç‰ˆæœ¬ï¼Œæˆ‘æœ€åæ˜¯ç”¨æœ€ç®€å•çš„ html ç›´æ¥è¿è¡Œçš„ã€‚ä¸è¿‡éœ€è¦è§£å†³ä¸‹ CORS è¯·æ±‚é—®é¢˜å°±æ˜¯äº†ï¼Œè¯¦ç»†çš„å¯ä»¥çœ‹æˆ‘çš„ github æºç  - [java ç‰ˆ GraphQL Server](https://github.com/l00437994/graphql-java-project)ã€‚

ä»¥ä¸Šéƒ½æ˜¯å…³äºæ­å»º Serverï¼Œé‚£ä¹ˆå…³äº Client ä¾§çš„ä½¿ç”¨ï¼šè¿™é‡Œæˆ‘åªä¸¾ Vue é¡¹ç›®å’Œå¾®ä¿¡å°ç¨‹åº

1. [Vue Apollo](https://apollo.vuejs.org/guide/)

ä½¿ç”¨ï¼š

![](/images/graphQL/graphql3.png)

è¿™é‡Œè¦æ³¨æ„çš„æ˜¯ï¼Œä¸€å®šè¦ç”¨ object æŠŠ apollo ä¸‹çš„å¯¹è±¡åŒ…èµ·æ¥ï¼š

```js
apollo: {

    //this won't work

    agreements: gql`

    query {

          agreements {

            agreementBody

            agreementName

          }

        }

    `,

    //wrap it in object

    agreements: {

      query: gql`

        query {

          agreements {

            agreementBody

            agreementName

          }

        }

      `

    }

  }
```

2. å¾®ä¿¡å°ç¨‹åºï¼š

ç”±äºæˆ‘çš„å‡ºå‘ç‚¹å®é™…ä¸Šæ˜¯æƒ³åº”ç”¨åœ¨å¾®ä¿¡å°ç¨‹åºï¼Œå‘ç°ç›´æ¥åœ¨å¾®ä¿¡å°ç¨‹åºä¸Šç”¨ vue-apollo æ˜¯ä¼šæŠ¥é”™çš„ã€‚

ä¸è¿‡å¾®ä¿¡æœ‰ä¸€å¥—è‡ªå·±ç»´æŠ¤çš„ graphql æ¡†æ¶ï¼šâ€˜wxapp-graphqlâ€™

ä½¿ç”¨ï¼š

```js
let gql = require('wxapp-graphql');

const GraphQL = gql.GraphQL;



gql = GraphQL({

    url: 'http://localhost:8080/graphql'

}, true);



export default gql;
```

åœ¨ä½ éœ€è¦çš„åœ°æ–¹ import gql from './ä¸Šé¢è¿™æ®µä»£ç .js'

é€šè¿‡ query ä¹‹åçš„å›è°ƒæ¥è®¿é—®æœ€åçš„ç»“æœï¼š

```js
gql.query({

                query: `query {

                            agreements {

                                agreementBody

                                agreementName

                                status

                                }

                        }`

            }).then(res => {

                console.log('query result: ', res);

            });
```

æœ€åæ˜¯å‡ ä¸ªæœ‰ç”¨çš„èµ„æ–™ï¼š

1\. vscode å¼€å‘æ’ä»¶ï¼š GraphQL; Idea å¼€å‘æ’ä»¶ï¼šjs-graphql

2\. typerscript-boilderplate:Â https://github.com/graphql-boilerplates/typescript-graphql-server

3\. wxapp-graphql:Â https://github.com/Authing/wxapp-graphql
