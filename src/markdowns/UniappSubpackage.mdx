---
title: uniapp 小程序包大小优化 - 主包与分包
description: 这次项目中遇到要新引入依赖，但是发现依赖进来之后包已经大的无法发布了。因此做了一次代码包的整改清理，有一些坑是我之前没想到的，在这里记录一下。
---
这次项目中遇到要新引入依赖，但是发现依赖进来之后包已经大的无法发布了。因此做了一次代码包的整改清理，有一些坑是我之前没想到的，在这里记录一下。

  

关于小程序的主包与分包：

  

目前主流小程序都支持分包的概念，uniapp目前也是支持的。

  

例如微信小程序，发布小程序时限制主包的大小不能超过2M，如果你什么都往主包放，那么迟早有一天会撑到上限，因此需要分包的概念。

  

### 分包的配置方法：

[https://uniapp.dcloud.io/collocation/pages?id=subpackages](https://uniapp.dcloud.io/collocation/pages?id=subpackages)  

  

实际上配置很简单，我认为有几点需要强调的是：

  

a. 如果你要把一个组件或js方法（vue最后也是打成JS，后面都按JS去一起说）放到某个分包里，这个JS必须不能被主包的任何JS直接或间接引入，否则一定会被打到主包里。

  

b. 主包的页面，JS，不可以直接或间接的引入分包的JS！但是反过来，分包可以引主包的JS。

  

c.  uniapp目前不支持分包加载其他分包的组件，但是微信小程序是支持的（[分包异步加载，可以看这里](https://developers.weixin.qq.com/miniprogram/dev/framework/subpackages/async.html)）

  

d. 分包可以引分包的JS，后果是这个JS会被打到主包里。分包不可以引分包的组件！预加载也不可以！除非用上面异步加载的方法！

  

uniapp官方推荐的分包方法：

  

\=》主包里只放默认启动页面/tabbar相关的页面，从tabbar页面开始跳转到的其他业务页面，全部放到分包里。 

  

但是由于上面分包的限制，默认启动页/tabbar相关页面里所有用到的组件，公共方法，静态图片，都必须在主包里。

  

综上，你可以看到你的主包里，不可避免的至少会有你的默认启动页，和看你的tabBar有多少个子项了。

  

  

最后有一点比较有趣的是关于npm依赖：

  

Q: npm依赖是否支持分包？如果我有个npm依赖只在某个分包里引用了，他可以只被打到分包里吗？

  

从我这次的经验来看，uniapp是一定会把npm依赖打到主包的vendor里的。不管他这个依赖是不是只在分包里引用了。而且例如像微信小程序，他不止会打到vendor里占位置，最后在主包的node-modules目录下也会有一定大小占着，举个例子：

  

![](/images/uniapp/uniapp1.png)

  

虽然node-modules下已经有这些依赖的代码了，但是假如仔细去看vendor的话，你会发现vendor下也会有这些依赖的代码。

  

这其实就很尴尬了，在vendor里占位置就算了，node-modules里又有一份，让我觉得很多余，而且又必须在主包里。但uniapp官方目前没有提供解决方法。

  

  

  

我后来找到一个方法，通过babel来修改依赖的路径，核心思想就是把这些依赖复制到分包里，用相对路径引用，然后再打包 =》

  

uni-app如何支持npm分包：[https://ask.dcloud.net.cn/article/37757](https://ask.dcloud.net.cn/article/37757)

  

这方法亲测有效，唯一的坏处就是他会把依赖的代码复制到你的源码里，因此你需要再他打完包后，在写段脚本把他们清掉。